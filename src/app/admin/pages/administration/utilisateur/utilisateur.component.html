<ngx-loading [show]="loading" [config]="{ backdropBorderRadius: '5px',fullScreenBackdrop:true }"></ngx-loading>
<div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12 mb-1">
        <div class="card">
            <div class="card-toolbar shadow-reset">
                <div class="row">
                    <div class="col-sm-4 col-md-4 col-lg-4">
                        <span class="header-text-position"><i class="mdi mdi-account-multiple mr-1"></i>EMPLOYES</span>
                    </div>
                    <div class="col-sm-4 col-md-4 col-lg-4"></div>
                    <div class="col-sm-4 col-md-4 col-lg-4">
                        <ul class="breadcome-menu">
                            <li class="teal">
                                <a [routerLink]="['/admin/administration']">Administration</a>
                                <span class="bread-slash">/</span>
                            </li>
                            <li><span class="bread-blod">Employés</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-12 col-md-12 col-lg-12" *ngIf="currentPage === 'list'">
        <div class="card">
            <div class="card-body shadow-reset">
                <div class="card-header toolbar-white">
                    <div class="row">
                        <div class="col-lg-2 col-md-2 col-sm-2">
                            <mat-form-field class="full-width">
                                <mat-label>Recherche par</mat-label>
                                <mat-select name="criteria" [(ngModel)]="searchParam.criteria">
                                    <mat-option value="1">Tous</mat-option>
                                    <mat-option value="2">Prénom ou nom</mat-option>
                                    <mat-option value="3">Téléphone</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <div class="col-lg-2 col-md-2 col-sm-2" *ngIf="searchParam.criteria === '2' || searchParam.criteria === '3'">
                            <mat-form-field class="full-width">
                                <input matInput name="searchTerm" [(ngModel)]="searchParam.query" placeholder="Entrer le terme ici ..." />
                            </mat-form-field>
                        </div>
                        <div class="col-sm-2 col-md-2 col-lg-2" *ngIf="utilisateurs?.length >0">
                            <mat-form-field class="full-width">
                                <input matInput type="text" (keyup)="applyFilter($event.target.value)" placeholder="Filtrer ...">
                            </mat-form-field>
                        </div>
                        <div class="col-sm-2 col-md-2 col-lg-2">
                            <div class="toolbar-buttons">
                                <button title="Actualiser" type="button" *ngIf="roleManager.isDroitChercherUtilisateur()" (click)="findUtilisateur()" class="btn btn-light bg-btn-refresh btn-icon mr-1">
                                    <i class="mdi mdi-cached text-muted c-white"></i>
                                </button>
                                <button title="Ajouter nouveau" type="button" *ngIf="roleManager.isDroitAjouterUtilisateur()" (click)="showAddForm()" class="btn btn-light bg-btn-add btn-icon">
                                    <i class="mdi mdi-plus text-muted c-white"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12 col-md-12 col-lg-12">
                        <table mat-table [dataSource]="dataSource" class="table-hover" matSort>

                            <ng-container matColumnDef="prenom">
                                <th mat-header-cell *matHeaderCellDef> PRENOM </th>
                                <td mat-cell *matCellDef="let row"> {{row.prenom}} </td>
                            </ng-container>

                            <ng-container matColumnDef="nom">
                                <th mat-header-cell *matHeaderCellDef> NOM </th>
                                <td mat-cell *matCellDef="let row"> {{row.nom}} </td>
                            </ng-container>

                            <ng-container matColumnDef="telephone">
                                <th mat-header-cell *matHeaderCellDef> TELEPHONE </th>
                                <td mat-cell *matCellDef="let row"> {{row.telephone}} </td>
                            </ng-container>

                            <ng-container matColumnDef="username">
                                <th mat-header-cell *matHeaderCellDef> LOGIN </th>
                                <td mat-cell *matCellDef="let row"> {{row.username}} </td>
                            </ng-container>

                            <ng-container matColumnDef="profile">
                                <th mat-header-cell *matHeaderCellDef> PROFIL </th>
                                <td mat-cell *matCellDef="let row"> {{row?.profile?.nom}} </td>
                            </ng-container>

                            <ng-container matColumnDef="etat">
                                <th mat-header-cell *matHeaderCellDef> ETAT </th>
                                <td mat-cell *matCellDef="let row" [ngStyle]="{'color': (row.enabled)? '#007b10' : '#d80000'}">
                                    {{row.enabled? 'Actif': 'Inactif'}}
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="action">
                                <th mat-header-cell *matHeaderCellDef> OPTION </th>
                                <td mat-cell *matCellDef="let row">
                                    <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Example icon-button with a menu">
                                        <i style="font-size: 20px; cursor: pointer;" class="mdi mdi-dots-vertical"></i>
                                    </button>
                                    <mat-menu #menu="matMenu">
                                        <button mat-menu-item [title]="'Voir detail de '+row.nomComplet" (click)="showDetail(row);">
                                            <i style="font-size: 20px; cursor: pointer;" class="mdi mdi-eye mr-1"></i>
                                            <span>Voir détail</span>
                                        </button>
                                        <button mat-menu-item *ngIf="roleManager.isDroitModifierUtilisateur()" [title]="'Modifier '+row.nomComplet" (click)="showEditForm(row)">
                                            <i style="font-size: 20px; cursor: pointer;"
                                                class="mdi mdi-pen c-app-1 mr-1"></i>
                                            <span>Modifier</span>
                                        </button>
                                        <button mat-menu-item [title]="'Désactiver ou activer '+row.nomComplet" (click)="showConfirmDialog(row, row.enabled? 'desactivate': 'activate')">
                                            <i *ngIf="!row.enabled && roleManager.isDroitActiverUtilisateur()"
                                                style="color:#007b10;font-size: 20px; cursor: pointer;"
                                                class="mdi mdi-toggle-switch-off mr-1"></i>
                                            <i *ngIf="row.enabled && roleManager.isDroitDesactiverUtilisateur()"
                                                style="color:#d80000;font-size: 20px; cursor: pointer;"
                                                class="mdi mdi-toggle-switch mr-1"></i>
                                            <span>{{row.enabled?'Desactiver':'Activer'}}</span>
                                        </button>
                                        <button mat-menu-item *ngIf="roleManager.isDroitReinitialiserPasswordUtilisateur()" title="Réinitialiser le mot de passe" (click)="showReinitialiserDialog(row)">
                                            <i style="font-size: 20px; cursor: pointer;"
                                                class="mdi mdi-lock-outline mr-1"></i>
                                            <span>Réinitialiser password</span>
                                        </button>
                                    </mat-menu>
                                </td>
                            </ng-container>
                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                        </table>
                        <div *ngIf="utilisateurs?.length===0" class="div-empty-list">
                            <br />
                            <div>
                                <img class="img-empty-list" src="assets/images/no_empty.png" alt="">
                                <h4 class="mt-2 c-app-1">Aucun resultat trouvé </h4>
                            </div>
                        </div>
                        <mat-paginator [pageSize]="25" [pageSizeOptions]="[25,50, 100]"></mat-paginator>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-12 col-md-12 col-lg-12" *ngIf="currentPage === 'detail'">
        <div class="card">
            <div class="card-body shadow-reset">
                <br>
                <div class="row">
                    <div class="col-xs-12 col-sm-1 col-md-1"></div>
                    <div class="col-xs-12 col-sm-10 col-md-10">

                        <div class="row">
                            <div class="col-xs-12 col-sm-6 col-md-6">
                                <mat-card>
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Prénom : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.prenom}}</span>
                                        </div>
                                    </div>
                                    <hr class="hr" />

                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Nom : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.nom}}</span>
                                        </div>
                                    </div>
                                    <hr class="hr" />

                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Tel mobile : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.telephone}}</span>
                                        </div>
                                    </div>
                                    <hr class="hr" />

                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Adresse : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.adresse}}</span>
                                        </div>
                                    </div>
                                    <hr class="hr" />

                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Date création : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.dateCreation | date: 'dd/MM/yyyy'}}</span>
                                        </div>
                                    </div>
                                    <hr class="hr" />

                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Email : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.email}}</span>
                                        </div>
                                    </div>
                                    <hr class="hr" />
                                    
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-5 col-md-5">
                                            <mat-label class="ft-w-b">Etat : </mat-label>
                                        </div>
                                        <div class="col-xs-12 col-sm-7 col-md-7">
                                            <span>{{utilisateur.enabled? 'Actif' : 'Inactif'}}</span>
                                        </div>
                                    </div>
                                </mat-card>
                                <br/>
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3">
                                <mat-card>
                                    <img *ngIf="!utilisateur.imageName" src="assets/images/no_user.png" width="100%" alt="PHOTO">
                                    <img *ngIf="utilisateur.imageName" [src]="urlDeBase + utilisateur.imageName" width="100%" height="200" alt="PHOTO">
                                </mat-card>
                                <br/>

                                <div class="row">
                                    <div class="col-xs-12 col-sm-4 col-md-4">
                                        <mat-label class="ft-w-b">Status : </mat-label>
                                    </div>
                                    <div class="col-xs-12 col-sm-8 col-md-8">
                                        <span [ngStyle]="{'color': (utilisateur.statusConnexion === 'ONLINE')? '#2fce2c' : '#d80000'}">
                                            {{utilisateur.statusConnexion}}
                                        </span>
                                    </div>
                                </div>
                                <hr class="hr" />
                            </div>
                        </div>
                        
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 col-lg-12" style="text-align: center;margin-top: 10px;">
                        <button (click)="showList()" class="btn btn-light btn-sm btn-rounded">
                            <i class="mdi mdi-close"></i> Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- add or Edit -->
<div class="content-body" *ngIf="currentPage === 'add' || currentPage === 'edit'">
    <div class="card">
        <div class="card-body shadow-reset">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-top: 10px;">
                    <h2 align="center" style="font-size: 18px;"> {{pageTitle}} </h2>
                </div>
                <div class="col-sm-2 col-md-2 col-lg-2"></div>
                <div class="col-sm-8 col-md-8 col-lg-8">
                    <br />
                    <form #utilisateurForm="ngForm" name="form">
                        <div class="row">
                            <div class="col-xs-12 col-sm-7 col-md-7">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-8 col-md-8">
                                        <mat-form-field class="full-width">
                                            <mat-label>Prénom</mat-label>
                                            <input matInput name="prenom" [(ngModel)]="utilisateur.prenom" required/>
                                        </mat-form-field>
                                    </div>
                                    <div class="col-xs-12 col-sm-8 col-md-8">
                                        <mat-form-field class="full-width">
                                            <mat-label>Nom</mat-label>
                                            <input matInput name="nom" [(ngModel)]="utilisateur.nom" required/>
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-5 col-md-5">
                                <br />
                                <br />
                                <img [src]="imageProfile" class="mb-1" alt="Photo" *ngIf="imageProfile" style="height: 200px; width:200px;">
                                <button *ngIf="imageProfile" class="bg-app-rouge c-white" style="margin-left: 20px;" title="Enlever la PHOTO" (click)="deleteImageProfile()">
                                    <i class="fa fa-close c-white"></i> Supprimer PHOTO
                                </button>
                                <button *ngIf="!imageProfile" class="bg-btn-refresh c-white" title="Browse PHOTO" (click)="selectPicture()">
                                    <i class="mdi mdi-download c-white"></i> Browse PHOTO
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12 col-sm-7 col-md-7">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-8 col-md-8">
                                        <mat-form-field class="full-width">
                                            <mat-label>Téléphone</mat-label>
                                            <input matInput name="telMobile" [(ngModel)]="utilisateur.telephone" required/>
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-5 col-md-5"></div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12 col-sm-12 col-md-12">
                                <mat-form-field class="full-width">
                                    <mat-label>Profile</mat-label>
                                    <mat-select name="profile" [(ngModel)]="utilisateur.profile" required>
                                        <div class=select-search-input>
                                            <input matInput type="text" name="profileFilter" focused="'true'" [(ngModel)]="profileFilter.nom" type="text" autocomplete="off" placeholder="Search ...">
                                            <span class="span-icon-filter">
                                                <i class="fa fa-search"></i>
                                            </span>
                                        </div>
                                        <mat-divider></mat-divider>
                                        <mat-option [value]="">Deselectionnez
                                            <button class="btn btn-deselect btn-sm button-deselect">X</button>
                                        </mat-option>
                                        <mat-option *ngFor="let profile of profiles | filterBy: profileFilter" [value]="profile">
                                            {{profile?.nom}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <div class="col-xs-12 col-sm-7 col-md-7">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-8 col-md-8">
                                        <mat-form-field class="full-width">
                                            <mat-label>E-mail</mat-label>
                                            <input matInput name="email" [(ngModel)]="utilisateur.email" />
                                        </mat-form-field>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-5 col-md-5">
                                <mat-form-field class="full-width">
                                    <mat-label>Adresse</mat-label>
                                    <textarea matInput name="adresse" [(ngModel)]="utilisateur.adresse" placeholder="Adresse" ></textarea>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="row" *ngIf="currentPage=== 'add'">
                            <div class="col-xs-12 col-sm-12 col-md-12">
                                <mat-form-field class="full-width">
                                    <mat-label>Nom d'utilisateur</mat-label>
                                    <input matInput name="username" [(ngModel)]="utilisateur.username" placeholder="Nom d'utilisateur" required />
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="row" *ngIf="currentPage=== 'add'">
                            <div class="col-xs-12 col-sm-6 col-md-6">
                                <mat-form-field class="full-width">
                                    <mat-label>Mot de passe</mat-label>
                                    <input matInput type="password" name="password" [(ngModel)]="utilisateur.password" placeholder="Mot de passe" required />
                                </mat-form-field>
                            </div>
                            <div class="col-xs-12 col-sm-6 col-md-6">
                                <mat-form-field class="full-width">
                                    <mat-label>Confirmez le mot de passe</mat-label>
                                    <input matInput type="password" name="confirmPassword" [(ngModel)]="utilisateur.oldPassword" placeholder="Confirmez le mot de passe" required />
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-top: 10px; margin-bottom: 10px;">
                            <div align="right">
                                <button (click)="showList()" class="btn btn-close btn-sm btn-rounded">
                                    <i class="mdi mdi-close"></i> Fermer
                                </button>&nbsp;&nbsp;
                                <button [disabled]="!utilisateurForm.form.valid" (click)="(utilisateur.id)? update() : save()" class="btn btn-light btn-sm btn-rounded">
                                    <i class="mdi mdi-content-save"></i> Enregistrer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- confim modal -->
<div *ngIf="currentPage === 'list'" class="modal fade text-xs-left" id="utilisateurConfirmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel2" aria-hidden="true">
    <div class="modal-sm modal-dialog " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button style="display: none;" type="button" #openConfirmDialog class="btn btn-outline-primary block btn-lg" data-toggle="modal" data-target="#utilisateurConfirmModal" data-backdrop="true">
                </button>
                <h4 class="modal-title" id="myModalLabel2">
                    {{(dialogAction && dialogAction === 'desactivate') ? 'Desactivation ' : 'Activation '}} de l'utilisateur
                </h4>
            </div>
            <div class="modal-body">
                <div style="color: red; font-weight: bold; font-size: 13px;text-align: center;">
                    <span class="text-bold-600">
                        Voulez-vous vraiment
                        {{(dialogAction && dialogAction ==='desactivate')? 'desactiver' : 'activer'}}
                        utilisateur ?<br />
                    </span>
                    <span style="color: #270067;"> {{utilisateur?.prenom}} {{utilisateur?.nom}}</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-close btn-sm btn-rounded mr-1" data-dismiss="modal">
                    <i class="mdi mdi-close"></i> Non
                </button>
                <button class="btn btn-light btn-sm btn-rounded" (click)="desactivateOrActivate()">
                    <i class="mdi mdi-check"></i> Oui
                </button>
            </div>
        </div>
    </div>
</div>

<input type="file" name="fileUpload" #fileInputUpload accept="image/*" style="visibility: hidden; height: 0px" (change)="onFileUploadChange($event)" [multiple]="false" />